services:
  web-ui:
    build: .
    container_name: media-web-ui
    restart: unless-stopped
    # Removed: ports - Access via Traefik at http://dashboard.lan or https://otterammo.xyz
    networks:
      - media-network      # Keep for backward compatibility (Iteration 1)
      - frontend-net      # User-facing dashboard
    environment:
      - TZ=${TZ:-UTC}
      - DOMAIN_SUFFIX=${DOMAIN_SUFFIX:-.lan}
      - PUBLIC_DASHBOARD_DOMAIN=${PUBLIC_DASHBOARD_DOMAIN:-otterammo.xyz}
      - SERVER_IP=${SERVER_IP:-192.168.86.111}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=media-network"

      # Public site routing via Cloudflare tunnel (HTTP)
      - "traefik.http.routers.web-ui-public.rule=Host(`${PUBLIC_DASHBOARD_DOMAIN:-otterammo.xyz}`)"
      - "traefik.http.routers.web-ui-public.entrypoints=web"
      - "traefik.http.routers.web-ui-public.service=web-ui"

      # Admin site HTTPS router (local domain)
      - "traefik.http.routers.web-ui-admin.rule=Host(`dashboard${DOMAIN_SUFFIX:-.lan}`)"
      - "traefik.http.routers.web-ui-admin.entrypoints=websecure"
      - "traefik.http.routers.web-ui-admin.tls=true"
      - "traefik.http.routers.web-ui-admin.service=web-ui"

      # HTTP redirect for local domain only
      - "traefik.http.routers.web-ui-admin-http.rule=Host(`dashboard${DOMAIN_SUFFIX:-.lan}`)"
      - "traefik.http.routers.web-ui-admin-http.entrypoints=web"
      - "traefik.http.routers.web-ui-admin-http.middlewares=redirect-to-https"
      - "traefik.http.routers.web-ui-admin-http.service=web-ui"

      # Service definition
      - "traefik.http.services.web-ui.loadbalancer.server.port=3000"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
