services:
  traefik:
    image: traefik:v3.6.6
    container_name: traefik
    restart: unless-stopped
    command:
      # Enable Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      # File provider for TLS config
      - "--providers.file.directory=/config"
      - "--providers.file.watch=true"
      # Entry points
      - "--entrypoints.web.address=:80"
      - "--entrypoints.jellyfin.address=:8096"
      - "--entrypoints.jellyseerr.address=:5055"
      - "--entrypoints.sonarr.address=:8989"
      - "--entrypoints.radarr.address=:7878"
      - "--entrypoints.prowlarr.address=:9696"
      - "--entrypoints.bazarr.address=:6767"
      - "--entrypoints.qbittorrent.address=:8080"
      - "--entrypoints.grafana.address=:3000"
      - "--entrypoints.prometheus.address=:9090"
      - "--entrypoints.alertmanager.address=:9093"
      - "--entrypoints.web-ui.address=:3001"
      - "--entrypoints.cadvisor.address=:8081"
      - "--entrypoints.dozzle.address=:8082"
      - "--entrypoints.traefik.address=:8085"
      - "--entrypoints.authelia.address=:9091"
      # API and dashboard
      - "--api.dashboard=true"
      - "--api.insecure=false"
      # Health check endpoint
      - "--ping=true"
      - "--ping.entrypoint=web"
      # Metrics
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.entryPoint=prometheus"
      # Logs
      - "--log.level=INFO"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
      - "--accesslog.bufferingsize=100"
    ports:
      - "80:80"       # HTTP entry point
      - "8096:8096"   # Jellyfin
      - "5055:5055"   # Jellyseerr
      - "8989:8989"   # Sonarr
      - "7878:7878"   # Radarr
      - "9696:9696"   # Prowlarr
      - "6767:6767"   # Bazarr
      - "8080:8080"   # qBittorrent
      - "3000:3000"   # Grafana
      - "9090:9090"   # Prometheus
      - "9093:9093"   # Alertmanager
      - "3001:3001"   # Web UI
      - "8081:8081"   # cAdvisor
      - "8082:8082"   # Dozzle
      - "8085:8085"   # Traefik Dashboard
      - "9091:9091"   # Authelia
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./logs:/var/log/traefik
      - ./config:/config
    environment:
      - TZ=${TZ:-UTC}
      - DOCKER_API_VERSION=1.44
    networks:
      - dmz-net
      - frontend-net
      - backend-net
      - security-net
      - download-net
      - mgmt-net
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping", "--ping.entrypoint=web", "--entrypoints.web.address=:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    labels:
      - "autoheal=true"
      - "traefik.enable=true"
      - "traefik.http.routers.traefik-dashboard.rule=Host(`${TAILSCALE_HOST}`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=traefik"
      - "traefik.http.routers.traefik-dashboard.tls=true"
      - "traefik.http.routers.traefik-dashboard.middlewares=authelia@docker"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
